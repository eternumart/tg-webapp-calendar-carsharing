<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–í—ã–±–æ—Ä –¥–∞—Ç—ã</title>
		<script src="https://telegram.org/js/telegram-web-app.js"></script>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
		<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
		<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
		<link rel="stylesheet" href="index.css" />
	</head>
	<body class="page">
		<h3 class="title">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</h3>
		<input class="calendar" type="text" id="calendar" />
		<button class="submit">–í—ã–±—Ä–∞—Ç—å –Ω–∞—á–∞–ª–æ</button>

		<script>
			const title = document.querySelector(".title");
			const calendarInput = document.getElementById("calendar");
			const button = document.querySelector(".submit");

			const picker = flatpickr(".calendar", {
				locale: "ru",
				dateFormat: "d.m.Y H:i",
				enableTime: true,
				time_24hr: true,
				inline: true,
			});

			button.addEventListener("click", handleSubmit);
			const tg = window.Telegram.WebApp;
			tg.ready();
			tg.expand();

			console.log("üß™ TG WebApp –∑–∞–≥—Ä—É–∂–µ–Ω", tg);
			console.log("üîç initDataUnsafe:", tg.initDataUnsafe);

			let startDateSelection = null;
			let selectingEnd = false;

			function parseDateTime(value) {
				const parts = value.trim().split(" ");
				if (parts.length < 2) return null;
				return {
					date: parts[0],
					time: parts[1],
				};
			}

			function resetPicker() {
				picker.clear();
				calendarInput.value = "";
			}

			function handleSubmit() {
				const dateValue = calendarInput.value;
				if (!dateValue) return;

				const parsed = parseDateTime(dateValue);
				if (!parsed) return;

				// First click: save start date/time and switch UI to end selection
				if (!selectingEnd) {
					startDateSelection = parsed;
					selectingEnd = true;
					title.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è";
					button.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω";
					resetPicker();
					console.log("‚úÖ –°—Ç–∞—Ä—Ç–æ–≤–∞—è –¥–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:", startDateSelection);
					return;
				}

				// Second click: send both start and end to Telegram
				const result = {
					startDate: startDateSelection,
					endDate: parsed,
				};

				console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞—Ç—ã –≤ Telegram:", result);
				tg.sendData(JSON.stringify(result));

				// Reset to initial state for a new selection
				selectingEnd = false;
				startDateSelection = null;
				title.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞";
				button.textContent = "–í—ã–±—Ä–∞—Ç—å –Ω–∞—á–∞–ª–æ";
				resetPicker();
			}
		</script>
	</body>
</html>
